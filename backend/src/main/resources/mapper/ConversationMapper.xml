<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.app.novelvoice.mapper.ConversationMapper">
    
    <insert id="insert" parameterType="com.app.novelvoice.entity.Conversation" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO conversations (user1_id, user2_id, last_message_id, last_message_time, create_time, update_time)
        VALUES (#{user1Id}, #{user2Id}, #{lastMessageId}, #{lastMessageTime}, #{createTime}, #{updateTime})
    </insert>
    
    <update id="update" parameterType="com.app.novelvoice.entity.Conversation">
        UPDATE conversations
        SET last_message_id = #{lastMessageId},
            last_message_time = #{lastMessageTime},
            update_time = #{updateTime}
        WHERE id = #{id}
    </update>
    
    <select id="selectById" resultType="com.app.novelvoice.entity.Conversation">
        SELECT * FROM conversations WHERE id = #{id}
    </select>
    
    <!-- 查询两个用户之间的会话（考虑用户顺序可能不同） -->
    <select id="selectByUsers" resultType="com.app.novelvoice.entity.Conversation">
        SELECT * FROM conversations
        WHERE (user1_id = #{user1Id} AND user2_id = #{user2Id})
           OR (user1_id = #{user2Id} AND user2_id = #{user1Id})
        LIMIT 1
    </select>
    
    <!-- 查询用户参与的所有会话 -->
    <select id="selectByUserId" resultType="com.app.novelvoice.entity.Conversation">
        SELECT * FROM conversations
        WHERE user1_id = #{userId} OR user2_id = #{userId}
        ORDER BY last_message_time DESC
    </select>
</mapper>
